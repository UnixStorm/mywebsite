<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UNIXSTORM</title>

<style>
body{
    margin:0;padding:0;height:100vh;
    background:url("3cc68b3f22ff5463843e82b661033950.jpg") no-repeat center center fixed;
    background-size:cover;font-family:Arial;
}
.center{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    width:280px;background:rgba(0,0,0,0.78);
    padding:20px;border-radius:12px;color:white;text-align:center;
}
input{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px;}
button{
    width:100%;padding:10px;margin-top:8px;
    background:#006CFF;border:none;border-radius:8px;color:white;font-weight:bold;
}
.link{margin-top:8px;color:#ccc;text-decoration:underline;cursor:pointer;}

#overlay{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.6);display:none;z-index:9999;
    justify-content:center;align-items:center;color:white;font-size:20px;
}
</style>
</head>
<body>

<!-- LOADING -->
<div id="overlay">Lütfen bekleyiniz...</div>

<div class="center">

<!-- KAYIT FORMU -->
<div id="registerBox">
<h3>Kayıt Ol</h3>
<input id="regName" placeholder="Kullanıcı adı">
<input id="regMail" placeholder="E-posta">
<input id="regPass" type="password" placeholder="Şifre">
<input id="regCode" placeholder="E-posta kodu">
<button id="regBtn">Kayıt Ol</button>
<div class="link" id="goLogin">Giriş Yap</div>
<div id="status"></div>
</div>

<!-- GİRİŞ FORMU -->
<div id="loginBox" style="display:none;">
<h3>Giriş Yap</h3>
<input id="logMail" placeholder="E-posta">
<input id="logPass" type="password" placeholder="Şifre">
<button id="logBtn">Giriş Yap</button>
<div class="link" id="goRegister">Kayıt Ol</div>
<div id="status2"></div>
</div>

</div>

<!-- SHA-256 -->
<script>
async function sha256(text){
    const msg = new TextEncoder().encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", msg);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b=>b.toString(16).padStart(2,"0")).join("");
}
</script>

<!-- EmailJS -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>emailjs.init("dCQownkzENRARtTC_");</script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

const config = {
    apiKey: "AIzaSyC5X_RnBnhy2k-X6Y_lezHgWbgK31Y5Dao",
    authDomain: "unixstorm-9dff8.firebaseapp.com",
    projectId: "unixstorm-9dff8",
    storageBucket: "unixstorm-9dff8.firebasestorage.app",
    messagingSenderId: "787509821542",
    appId: "1:787509821542:web:2b54b5bafee1207edeada7",
    measurementId: "G-BQYS1575QZ",
    databaseURL: "https://unixstorm-9dff8-default-rtdb.firebaseio.com/"
};

const app = initializeApp(config);
const db  = getDatabase(app);

/* ELEMENTLER */
const overlay = document.getElementById("overlay");
const regBox  = document.getElementById("registerBox");
const logBox  = document.getElementById("loginBox");
const status  = document.getElementById("status");
const status2 = document.getElementById("status2");

function showLoad(){ overlay.style.display="flex"; }
function hideLoad(){ overlay.style.display="none"; }

document.getElementById("goLogin").onclick=()=>{regBox.style.display="none";logBox.style.display="block";}
document.getElementById("goRegister").onclick=()=>{logBox.style.display="none";regBox.style.display="block";}

let mailKod=null;

/* ⭐ KAYIT ⭐ */
document.getElementById("regBtn").onclick = async()=>{
    const name  = regName.value.trim();
    const mail  = regMail.value.trim();
    const pass  = regPass.value.trim();
    const code  = regCode.value.trim();

    if(!name||!mail||!pass){ status.textContent="Boş bırakma."; return; }

    showLoad();

    // Kod yoksa gönder
    if(!mailKod){
        mailKod = Math.floor(100000+Math.random()*900000);
        await emailjs.send("service_vbm28pq","template_507m11j",{kod:mailKod,mail:mail});
        hideLoad();
        status.textContent="Mailine gelen kodu gir.";
        return;
    }

    // Kod yanlış
    if(code!=mailKod){
        hideLoad();
        status.textContent="Kod yanlış!";
        return;
    }

    const passHash = await sha256(pass);

    const uid = "uid_" + Date.now();

    await set(ref(db,"users/"+uid),{
        name:name,
        email:mail,
        pass:passHash
    });

    localStorage.setItem("sessionUser", uid);

    hideLoad();
    status.textContent="Kayıt başarılı!";
    setTimeout(()=> location.href="ana_site.html", 1000);
};

/* ⭐ GİRİŞ ⭐ */
document.getElementById("logBtn").onclick = async()=>{
    const mail = logMail.value.trim();
    const pass = logPass.value.trim();

    if(!mail||!pass){status2.textContent="Boş bırakma.";return;}

    showLoad();

    const snapshot = await get(child(ref(db),"users"));
    if(!snapshot.exists()){
        hideLoad();
        status2.textContent="Kullanıcı bulunamadı.";
        return;
    }

    const passHash = await sha256(pass);

    let ok=false;

    snapshot.forEach(user=>{
        if(user.val().email===mail && user.val().pass===passHash){
            ok=true;
            localStorage.setItem("sessionUser", user.key);
        }
    });

    hideLoad();

    if(ok){
        status2.textContent="Giriş başarılı!";
        setTimeout(()=> location.href="ana_site.html", 800);
    }else{
        status2.textContent="Bilgiler yanlış.";
    }
};

</script>
</body>
    </html>
